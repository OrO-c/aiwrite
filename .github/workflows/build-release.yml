name: Build and Release APK

on:
  # è‡ªåŠ¨è§¦å‘ï¼šæŽ¨é€åˆ° main åˆ†æ”¯çš„ tag
  push:
    tags:
      - 'v*.*.*'
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      version_name:
        description: 'Version name (e.g., 1.0.0)'
        required: true
        default: '1.0.0'
      version_code:
        description: 'Version code (integer)'
        required: true
        default: '1'
      build_type:
        description: 'Build type'
        required: true
        default: 'release'
        type: choice
        options:
          - release
          - debug
      create_release:
        description: 'Create GitHub Release'
        required: false
        default: true
        type: boolean

env:
  # æž„å»ºçŽ¯å¢ƒå˜é‡
  GRADLE_OPTS: -Dorg.gradle.jvmargs="-Xmx4g -XX:+HeapDumpOnOutOfMemoryError"
  GRADLE_USER_HOME: ${{ github.workspace }}/.gradle

jobs:
  build:
    name: Build APK
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        # å¤šæž¶æž„æž„å»ºçŸ©é˜µ
        include:
          - arch: 'universal'
            abi: 'universal'
          - arch: 'arm64-v8a'
            abi: 'arm64-v8a'
          - arch: 'armeabi-v7a'
            abi: 'armeabi-v7a'
          - arch: 'x86_64'
            abi: 'x86_64'
          - arch: 'x86'
            abi: 'x86'
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: 34
          build-tools: 34.0.0
          ndk-version: 25.2.9519653
      
      - name: Cache Gradle Dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            .gradle
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-
      
      - name: Grant Execute Permission for gradlew
        run: chmod +x gradlew
      
      - name: Extract Version Information
        id: version_info
        run: |
          if [ "${{ github.event_name }}" == "push" ]; then
            # ä»Ž tag æå–ç‰ˆæœ¬ä¿¡æ¯
            VERSION_NAME=${GITHUB_REF#refs/tags/v}
            VERSION_CODE=${{ github.run_number }}
            BUILD_TYPE="release"
          else
            # ä»Žæ‰‹åŠ¨è¾“å…¥èŽ·å–ç‰ˆæœ¬ä¿¡æ¯
            VERSION_NAME="${{ github.event.inputs.version_name }}"
            VERSION_CODE="${{ github.event.inputs.version_code }}"
            BUILD_TYPE="${{ github.event.inputs.build_type }}"
          fi
          
          echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "version_code=$VERSION_CODE" >> $GITHUB_OUTPUT
          echo "build_type=$BUILD_TYPE" >> $GITHUB_OUTPUT
          echo "Version: $VERSION_NAME ($VERSION_CODE) - $BUILD_TYPE"
      
      - name: Update Version in build.gradle
        run: |
          sed -i "s/versionCode [0-9]*/versionCode ${{ steps.version_info.outputs.version_code }}/" app/build.gradle
          sed -i "s/versionName \".*\"/versionName \"${{ steps.version_info.outputs.version_name }}\"/" app/build.gradle
          echo "Updated version in build.gradle:"
          grep -E "versionCode|versionName" app/build.gradle
      
      - name: Configure Multi-Architecture Build
        run: |
          # æ·»åŠ å¤šæž¶æž„é…ç½®åˆ° build.gradle
          cat >> app/build.gradle << EOF
          
          android {
              splits {
                  abi {
                      enable true
                      reset()
                      if ("${{ matrix.abi }}" != "universal") {
                          include "${{ matrix.abi }}"
                      } else {
                          universalApk true
                      }
                      universalApk ${{ matrix.abi == 'universal' && 'true' || 'false' }}
                  }
              }
          }
          
          // ä¸ºä¸åŒæž¶æž„è®¾ç½®ä¸åŒçš„ version code
          android.applicationVariants.all { variant ->
              variant.outputs.each { output ->
                  def abiVersionCode = project.ext.abiCodes.get(output.getFilter(com.android.build.OutputFile.ABI))
                  if (abiVersionCode != null) {
                      output.versionCodeOverride = abiVersionCode + variant.versionCode
                  }
              }
          }
          
          project.ext.abiCodes = [
              'armeabi-v7a': 1,
              'arm64-v8a': 2,
              'x86': 3,
              'x86_64': 4,
              'universal': 0
          ]
          EOF
      
      - name: Build APK
        run: |
          if [ "${{ steps.version_info.outputs.build_type }}" == "release" ]; then
            ./gradlew assembleRelease --stacktrace
          else
            ./gradlew assembleDebug --stacktrace
          fi
      
      - name: Sign APK (Release only)
        if: steps.version_info.outputs.build_type == 'release'
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          if [ -n "$KEYSTORE_PASSWORD" ]; then
            echo "Signing APK..."
            # åˆ›å»ºä¸´æ—¶å¯†é’¥åº“ï¼ˆå®žé™…ä½¿ç”¨ä¸­åº”è¯¥ä¸Šä¼ çœŸå®žçš„å¯†é’¥åº“ï¼‰
            keytool -genkey -v -keystore release.keystore -alias release -keyalg RSA -keysize 2048 -validity 10000 \
              -storepass $KEYSTORE_PASSWORD -keypass $KEY_PASSWORD \
              -dname "CN=AI Writing Assistant, OU=Development, O=Company, L=City, S=State, C=CN"
            
            # ç­¾å APK
            find app/build/outputs/apk/release -name "*.apk" -exec \
              jarsigner -verbose -sigalg SHA256withRSA -digestalg SHA-256 \
              -keystore release.keystore -storepass $KEYSTORE_PASSWORD -keypass $KEY_PASSWORD {} release \;
          else
            echo "No signing credentials provided, skipping APK signing"
          fi
      
      - name: Rename APK Files
        run: |
          BUILD_TYPE="${{ steps.version_info.outputs.build_type }}"
          VERSION_NAME="${{ steps.version_info.outputs.version_name }}"
          ARCH="${{ matrix.arch }}"
          
          # æŸ¥æ‰¾å¹¶é‡å‘½å APK æ–‡ä»¶
          APK_DIR="app/build/outputs/apk/$BUILD_TYPE"
          
          if [ "$ARCH" == "universal" ]; then
            # Universal APK
            find $APK_DIR -name "*universal*.apk" -exec mv {} "AI-Writing-Assistant-v${VERSION_NAME}-universal-${BUILD_TYPE}.apk" \; || \
            find $APK_DIR -name "*.apk" | head -1 | xargs -I {} mv {} "AI-Writing-Assistant-v${VERSION_NAME}-universal-${BUILD_TYPE}.apk"
          else
            # Architecture-specific APK
            find $APK_DIR -name "*${ARCH}*.apk" -exec mv {} "AI-Writing-Assistant-v${VERSION_NAME}-${ARCH}-${BUILD_TYPE}.apk" \; || \
            echo "No APK found for architecture $ARCH"
          fi
          
          # åˆ—å‡ºç”Ÿæˆçš„æ–‡ä»¶
          ls -la *.apk || echo "No APK files found in current directory"
      
      - name: Upload APK Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: apk-${{ matrix.arch }}-${{ steps.version_info.outputs.build_type }}
          path: |
            *.apk
          retention-days: 30
      
      - name: Generate APK Info
        id: apk_info
        run: |
          APK_FILE=$(ls *.apk | head -1)
          if [ -f "$APK_FILE" ]; then
            APK_SIZE=$(stat -c%s "$APK_FILE" | numfmt --to=iec)
            APK_NAME=$(basename "$APK_FILE")
            echo "apk_name=$APK_NAME" >> $GITHUB_OUTPUT
            echo "apk_size=$APK_SIZE" >> $GITHUB_OUTPUT
            echo "apk_exists=true" >> $GITHUB_OUTPUT
            
            # ç”Ÿæˆ APK ä¿¡æ¯
            echo "APK: $APK_NAME ($APK_SIZE)"
          else
            echo "apk_exists=false" >> $GITHUB_OUTPUT
          fi

  create_release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')) ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true')
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Download All APK Artifacts
        uses: actions/download-artifact@v4
        with:
          path: apk-artifacts
          pattern: apk-*
          merge-multiple: false
      
      - name: Prepare Release Assets
        run: |
          mkdir -p release-assets
          
          # æ”¶é›†æ‰€æœ‰ APK æ–‡ä»¶
          find apk-artifacts -name "*.apk" -exec cp {} release-assets/ \;
          
          # åˆ—å‡ºæ‰€æœ‰æ–‡ä»¶
          echo "Release assets:"
          ls -la release-assets/
          
          # ç”Ÿæˆ checksums
          cd release-assets
          sha256sum *.apk > checksums.txt
          cd ..
      
      - name: Extract Version Info
        id: version
        run: |
          if [ "${{ github.event_name }}" == "push" ]; then
            VERSION_NAME=${GITHUB_REF#refs/tags/v}
          else
            VERSION_NAME="${{ github.event.inputs.version_name }}"
          fi
          echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
      
      - name: Generate Release Notes
        id: release_notes
        run: |
          cat > release_notes.md << EOF
          # AI å†™ä½œåŠ©æ‰‹ v${{ steps.version.outputs.version_name }}
          
          ## ðŸ“± ä¸‹è½½è¯´æ˜Ž
          
          è¯·æ ¹æ®æ‚¨çš„è®¾å¤‡æž¶æž„ä¸‹è½½å¯¹åº”çš„ APKï¼š
          
          - **Universal APK**: å…¼å®¹æ‰€æœ‰æž¶æž„ï¼Œæ–‡ä»¶è¾ƒå¤§
          - **ARM64 (arm64-v8a)**: é€‚ç”¨äºŽå¤§å¤šæ•°çŽ°ä»£ Android è®¾å¤‡
          - **ARM32 (armeabi-v7a)**: é€‚ç”¨äºŽè¾ƒè€çš„ 32 ä½ ARM è®¾å¤‡
          - **x86_64**: é€‚ç”¨äºŽ 64 ä½ x86 è®¾å¤‡ï¼ˆå¦‚æŸäº›å¹³æ¿å’Œæ¨¡æ‹Ÿå™¨ï¼‰
          - **x86**: é€‚ç”¨äºŽ 32 ä½ x86 è®¾å¤‡
          
          ## ðŸ” å¦‚ä½•é€‰æ‹©
          
          1. **ä¸ç¡®å®š**: ä¸‹è½½ Universal APK
          2. **çŽ°ä»£æ‰‹æœº**: é€šå¸¸é€‰æ‹© ARM64 ç‰ˆæœ¬
          3. **è€æ—§è®¾å¤‡**: é€‰æ‹© ARM32 ç‰ˆæœ¬
          4. **æ¨¡æ‹Ÿå™¨**: æ ¹æ®æ¨¡æ‹Ÿå™¨æž¶æž„é€‰æ‹© x86 ç‰ˆæœ¬
          
          ## âœ¨ ä¸»è¦åŠŸèƒ½
          
          - ðŸ¤– æ™ºèƒ½åˆ†æ®µå†™ä½œï¼šä¸€æ¬¡è¾“å…¥ï¼Œä¸‰ç§é£Žæ ¼
          - âš¡ åŒæ¨¡å¼æ“ä½œï¼šç£è´´æ¨¡å¼ + æ‚¬æµ®çƒæ¨¡å¼
          - ðŸ“ å¤šåœºæ™¯é¢„è®¾ï¼šå°çº¢ä¹¦ã€é‚®ä»¶ã€è¯„ä»·ç­‰
          - ðŸŽ¨ çŽ°ä»£åŒ–è®¾è®¡ï¼šMaterial 3 + å¤œé—´æ¨¡å¼
          - ðŸ”’ éšç§å®‰å…¨ï¼šæœ¬åœ°å­˜å‚¨ï¼Œç”¨æˆ·æŽ§åˆ¶
          
          ## ðŸ“‹ æ›´æ–°å†…å®¹
          
          - é¦–æ¬¡å‘å¸ƒç‰ˆæœ¬
          - å®Œæ•´çš„åŒæ¨¡å¼å†™ä½œåŠŸèƒ½
          - æ”¯æŒ OpenAIã€DeepSeekã€Gemini API
          - å†…ç½®å¸¸ç”¨å†™ä½œé¢„è®¾
          - å®Œæ•´çš„å¼•å¯¼æµç¨‹
          
          ## ðŸ”§ ç³»ç»Ÿè¦æ±‚
          
          - Android 7.0 (API 24) åŠä»¥ä¸Š
          - ç½‘ç»œè¿žæŽ¥ï¼ˆç”¨äºŽ AI API è°ƒç”¨ï¼‰
          - å¯é€‰ï¼šæ‚¬æµ®çª—æƒé™ï¼ˆæ‚¬æµ®çƒæ¨¡å¼ï¼‰
          - å¯é€‰ï¼šæ— éšœç¢æœåŠ¡ï¼ˆç›´æŽ¥è¾“å…¥åŠŸèƒ½ï¼‰
          
          ## ðŸ“ æ–‡ä»¶æ ¡éªŒ
          
          æ‰€æœ‰ APK æ–‡ä»¶çš„ SHA256 æ ¡éªŒå€¼è¯·å‚è€ƒ \`checksums.txt\` æ–‡ä»¶ã€‚
          EOF
          
          echo "Generated release notes"
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event_name == 'push' && github.ref_name || format('v{0}', steps.version.outputs.version_name) }}
          name: AI å†™ä½œåŠ©æ‰‹ v${{ steps.version.outputs.version_name }}
          body_path: release_notes.md
          draft: false
          prerelease: false
          files: |
            release-assets/*.apk
            release-assets/checksums.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify:
    name: Build Notification
    needs: [build, create_release]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Send Build Notification
        if: always()
        run: |
          if [ "${{ needs.build.result }}" == "success" ]; then
            echo "âœ… Build completed successfully!"
            echo "Version: ${{ needs.build.outputs.version_name || github.event.inputs.version_name }}"
            echo "Architectures: universal, arm64-v8a, armeabi-v7a, x86_64, x86"
          else
            echo "âŒ Build failed!"
            exit 1
          fi
      
      - name: Build Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # ðŸ—ï¸ Build Summary
          
          ## Build Information
          - **Trigger**: ${{ github.event_name }}
          - **Version**: ${{ needs.build.outputs.version_name || github.event.inputs.version_name }}
          - **Build Type**: ${{ github.event.inputs.build_type || 'release' }}
          - **Status**: ${{ needs.build.result }}
          
          ## Artifacts
          - âœ… Universal APK
          - âœ… ARM64 APK  
          - âœ… ARM32 APK
          - âœ… x86_64 APK
          - âœ… x86 APK
          
          ## Next Steps
          1. Download artifacts from the Actions page
          2. Test on different device architectures
          3. Check the release page for published APKs
          EOF