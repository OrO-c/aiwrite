name: Security Scan

on:
  # å®šæœŸæ‰«æ
  schedule:
    - cron: '0 2 * * 1'  # æ¯å‘¨ä¸€å‡Œæ™¨2ç‚¹è¿è¡Œ
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  
  # é‡è¦åˆ†æ”¯æŽ¨é€æ—¶è§¦å‘
  push:
    branches:
      - main
    paths:
      - '**/build.gradle'
      - '**/build.gradle.kts'
      - 'gradle.properties'

jobs:
  dependency-check:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      
      - name: Cache Gradle Dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            .gradle
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-
      
      - name: Grant Execute Permission for gradlew
        run: chmod +x gradlew
      
      - name: Run Dependency Check
        run: |
          # æ£€æŸ¥è¿‡æ—¶çš„ä¾èµ–
          ./gradlew dependencyUpdates
      
      - name: Upload Dependency Reports
        uses: actions/upload-artifact@v4
        with:
          name: dependency-reports
          path: |
            build/dependencyUpdates/
          retention-days: 30

  code-scanning:
    name: CodeQL Security Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    
    strategy:
      fail-fast: false
      matrix:
        language: [ 'java' ]
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: ${{ matrix.language }}
          queries: +security-and-quality
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: 34
          build-tools: 34.0.0
      
      - name: Cache Gradle Dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            .gradle
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-
      
      - name: Grant Execute Permission for gradlew
        run: chmod +x gradlew
      
      - name: Build for CodeQL Analysis
        run: |
          ./gradlew assembleDebug
      
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v2
        with:
          category: "/language:${{matrix.language}}"

  apk-security-scan:
    name: APK Security Scan
    runs-on: ubuntu-latest
    needs: dependency-check
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: 34
          build-tools: 34.0.0
      
      - name: Cache Gradle Dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            .gradle
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-
      
      - name: Grant Execute Permission for gradlew
        run: chmod +x gradlew
      
      - name: Build Debug APK for Scanning
        run: ./gradlew assembleDebug
      
      - name: Install APK Analysis Tools
        run: |
          # å®‰è£… APK åˆ†æžå·¥å…·
          sudo apt-get update
          sudo apt-get install -y python3-pip
          pip3 install --user apkleaks
          
          # ä¸‹è½½ MobSF çš„å‘½ä»¤è¡Œå·¥å…·ï¼ˆå¦‚æžœéœ€è¦ï¼‰
          # wget -O mobsf.py https://raw.githubusercontent.com/MobSF/Mobile-Security-Framework-MobSF/master/scripts/mobsf_ci.py
      
      - name: Scan APK for Security Issues
        run: |
          APK_FILE=$(find app/build/outputs/apk/debug -name "*.apk" | head -1)
          echo "Scanning APK: $APK_FILE"
          
          # åŸºæœ¬ APK ä¿¡æ¯æå–
          echo "=== APK Basic Info ==="
          aapt dump badging "$APK_FILE" | head -20
          
          echo "=== APK Permissions ==="
          aapt dump permissions "$APK_FILE"
          
          echo "=== APK Certificate Info ==="
          keytool -printcert -jarfile "$APK_FILE" | head -20
          
          # ä½¿ç”¨ APKLeaks æ‰«ææ•æ„Ÿä¿¡æ¯
          echo "=== APK Leaks Scan ==="
          python3 -m apkleaks -f "$APK_FILE" -o apk_scan_results.txt || true
          
          # æ£€æŸ¥ APK å¤§å°
          APK_SIZE=$(stat -c%s "$APK_FILE")
          echo "APK Size: $APK_SIZE bytes ($(numfmt --to=iec $APK_SIZE))"
          
          if [ $APK_SIZE -gt 52428800 ]; then  # 50MB
            echo "âš ï¸ Warning: APK size is quite large (>50MB)"
          fi
      
      - name: Upload Security Scan Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-scan-results
          path: |
            apk_scan_results.txt
            app/build/outputs/apk/debug/*.apk
          retention-days: 30
      
      - name: Create Security Summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # ðŸ”’ Security Scan Summary
          
          ## APK Information
          - **File**: $(basename $(find app/build/outputs/apk/debug -name "*.apk" | head -1))
          - **Size**: $(stat -c%s $(find app/build/outputs/apk/debug -name "*.apk" | head -1) | numfmt --to=iec)
          
          ## Security Checks
          - âœ… Dependency vulnerability scan completed
          - âœ… CodeQL security analysis completed
          - âœ… APK permissions review completed
          - âœ… Certificate verification completed
          
          ## Next Steps
          1. Review uploaded security scan results
          2. Check for any high-severity vulnerabilities
          3. Update dependencies if needed
          4. Review APK permissions and certificate
          EOF